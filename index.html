
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>阿里云 RTS & GELLO 远程控制台</title>
  <link rel="stylesheet" href="https://g.alicdn.com/de/prismplayer/2.9.9/skins/default/aliplayer-min.css" />
  
  <style>
    :root {
      --bg-page: #F5F5F7;
      --text-primary: #1D1D1F;
      --text-secondary: #86868B;
      --accent-blue: #0071E3;
      --glass-bg: rgba(255, 255, 255, 0.65);
      --glass-border: rgba(255, 255, 255, 0.4);
      --video-radius: 20px;
      --panel-radius: 24px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-font-smoothing: antialiased; }

    body {
      font-family: "SF Pro Display", "SF Pro Icons", "Helvetica Neue", Helvetica, Arial, sans-serif;
      background-color: var(--bg-page);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    .header { text-align: center; margin-bottom: 30px; max-width: 800px; animation: fadeIn 0.8s ease-out; }
    .header h1 { font-size: 40px; font-weight: 600; letter-spacing: -0.015em; margin-bottom: 10px; color: var(--text-primary); }
    .header p { font-size: 17px; color: var(--text-secondary); }

    /* --- 布局修改：三列布局 --- */
    .video-grid {
      display: grid;
      grid-template-columns: 1fr 1.6fr 1fr; 
      gap: 24px;
      width: 100%;
      max-width: 1800px;
      margin-bottom: 30px;
      align-items: center;
    }

    .video-wrapper {
      position: relative;
      width: 100%;
      padding-top: 56.25%; /* 16:9 */
      background: #000;
      border-radius: var(--video-radius);
      overflow: hidden;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.08); 
      transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }

    .video-wrapper.main-stage {
      z-index: 2;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
      transform: scale(1.02);
    }

    .video-wrapper:hover {
      transform: scale(1.03);
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
    }

    .video-label {
      position: absolute;
      top: 16px; left: 16px;
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      padding: 4px 12px; border-radius: 16px;
      font-size: 11px; font-weight: 600;
      color: var(--text-primary); z-index: 10;
      pointer-events: none;
    }
    
    /* 设置面板样式 */
    .settings-panel { 
      width: 100%; max-width: 1000px; margin-bottom: 30px; padding: 24px; 
      background: #fff; border-radius: 20px; 
      box-shadow: 0 4px 20px rgba(0,0,0,0.03); 
      display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;
      border: 1px solid rgba(0,0,0,0.05);
    }
    .input-group { display: flex; flex-direction: column; flex: 1; min-width: 250px; }
    .input-group label { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500; letter-spacing: 0.5px; }
    .input-group input { 
      padding: 12px 16px; border: 1px solid #E5E5EA; border-radius: 12px; 
      font-size: 15px; outline: none; transition: all 0.2s; background: #F2F2F7;
      color: var(--text-primary);
    }
    .input-group input:focus { border-color: var(--accent-blue); background: #fff; box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.1); }
    
    /* 播放器定位 */
    #J_prismPlayer_Center, #J_prismPlayer_Left, #J_prismPlayer_Right {
      position: absolute !important; top: 0; left: 0; width: 100% !important; height: 100% !important;
    }

    /* 控制台 */
    .control-island {
      width: 100%; max-width: 1000px;
      background: var(--glass-bg);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--panel-radius);
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.03);
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 40px;
      align-items: center;
    }

    .latency-display { text-align: left; padding-right: 30px; border-right: 1px solid rgba(0,0,0,0.05); }
    .latency-value { font-size: 56px; font-weight: 600; color: var(--text-primary); letter-spacing: -2px; line-height: 1; }
    .latency-unit { font-size: 18px; font-weight: 500; color: var(--text-secondary); margin-left: 5px; }
    .latency-label { font-size: 13px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-top: 8px; letter-spacing: 0.5px; }

    .controls-area { display: flex; flex-direction: column; gap: 20px; }
    .btn-row { display: flex; gap: 12px; flex-wrap: wrap; }

    button {
      border: none; background: rgba(0,0,0,0.05); color: var(--text-primary);
      padding: 14px 24px; border-radius: 980px; font-size: 15px; font-weight: 500;
      cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px; justify-content: center;
    }
    button:hover { background: rgba(0,0,0,0.1); }
    button:active { transform: scale(0.98); }
    button.primary { background: var(--accent-blue); color: white; }
    button.primary:hover { background: #0077ED; box-shadow: 0 4px 15px rgba(0, 113, 227, 0.3); }
    button.mode-active { background: var(--text-primary); color: white; }
    
    .gello-btn { width: 100%; justify-content: center; background: linear-gradient(90deg, #FF2D55, #FF375F); color: white; font-weight: 600; }
    .gello-btn:hover { background: linear-gradient(90deg, #FF375F, #FF2D55); box-shadow: 0 4px 15px rgba(255, 45, 85, 0.3); }

    .status-bar { display: flex; justify-content: space-between; width: 100%; max-width: 1000px; margin-top: 20px; padding: 0 20px; font-size: 13px; color: var(--text-secondary); }
    .status-item { display: flex; align-items: center; gap: 8px; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: #ccc; }
    .dot.green { background: #34C759; box-shadow: 0 0 8px rgba(52, 199, 89, 0.4); }
    .dot.red { background: #FF3B30; }
    .dot.blue { background: var(--accent-blue); animation: pulse 2s infinite; }

    @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    #error-message { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 12px 24px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); color: #FF3B30; font-weight: 500; z-index: 100; display: none; }

    @media (max-width: 1200px) {
      .video-grid { grid-template-columns: 1fr; max-width: 800px; }
      .video-wrapper.main-stage { order: -1; }
      .control-island { grid-template-columns: 1fr; gap: 20px; text-align: center; }
      .latency-display { padding-right: 0; border-right: none; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 20px; }
    }
  </style>
</head>
<body>

  <div id="error-message"></div>

  <div class="header">
    <h1>RTS 3-View Teleoperation</h1>
    <p>多视角超低延迟遥操作终端</p>
  </div>

  <!-- 1. 连接设置面板 (预填了你的 Ngrok 地址) -->
  <div class="settings-panel">
    <div class="input-group">
      <label>后端 API 地址 (Ngrok URL)</label>
      <!-- 在这里预填了你的地址 -->
      <input type="text" id="api-url" placeholder="https://xxxx.ngrok-free.app" value="https://vicente-unspottable-galina.ngrok-free.dev">
    </div>
    <div class="input-group" style="max-width: 200px;">
      <label>访问密码 (Token)</label>
      <input type="password" id="api-token" placeholder="Token" value="gello123">
    </div>
    <button onclick="connectBackend()" class="primary" style="height: 46px; margin-bottom: 1px;">
      <span id="connect-text">连接服务器</span>
    </button>
  </div>

  <!-- 2. 视频区域 -->
  <div class="video-grid">
    <!-- 左侧 (C) -->
    <div class="video-wrapper">
      <div class="video-label">Left View (C)</div>
      <div id="J_prismPlayer_Left"></div>
    </div>

    <!-- 中间 (A - Main) -->
    <div class="video-wrapper main-stage">
      <div class="video-label">Main View (A)</div>
      <div id="J_prismPlayer_Center"></div>
    </div>

    <!-- 右侧 (E) -->
    <div class="video-wrapper">
      <div class="video-label">Right View (E)</div>
      <div id="J_prismPlayer_Right"></div>
    </div>
  </div>

  <!-- 3. 控制岛 -->
  <div class="control-island">
    <div class="latency-display">
      <div>
        <span class="latency-value" id="latency-value">--</span>
        <span class="latency-unit">ms</span>
      </div>
      <div class="latency-label">Avg. Latency</div>
    </div>

    <div class="controls-area">
      <div class="btn-row">
        <button class="primary" id="play-btn" onclick="playAllVideos()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg> 播放全部
        </button>
        <button onclick="pauseAllVideos()" id="pause-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg> 暂停
        </button>
        <button onclick="toggleMuteAll()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .9-.2 1.74-.54 2.5l1.45 1.45C20.37 14.28 21 13.19 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.87.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.28 4.28c-.45.39-.99.7-1.6 1L16 21l1.5-1.5 2.5-2.5L21 18l1.5-1.5L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/></svg>
        </button>
      </div>

      <div class="btn-row">
        <button id="low-latency-btn" onclick="switchToLowLatency()" class="mode-active">RTS 极速模式</button>
        <button id="standard-btn" onclick="switchToStandard()">标准模式</button>
      </div>

      <div class="btn-row" style="width: 100%;">
        <button class="gello-btn" id="gello-btn" onclick="startGelloTeleop()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 16a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/><path d="M12 8v-2"/><path d="M12 16v2"/><path d="M16 12h2"/><path d="M8 12H6"/></svg>
          启动 GELLO 远程遥操作
        </button>
      </div>
    </div>
  </div>

  <div class="status-bar">
    <div class="status-item">
      <div class="dot green" id="status-dot"></div>
      <span id="status">Systems Ready</span>
    </div>
    <div class="status-item">
      <div class="dot blue" id="backend-dot"></div>
      <span id="gello-backend-status">Backend checking...</span>
    </div>
    <div class="status-item">
      <span id="current-protocol">ARTC / 3-Stream</span>
    </div>
  </div>

  <script charset="utf-8" type="text/javascript" src="https://g.alicdn.com/de/prismplayer/2.9.9/aliplayer-min.js"></script>
  <script>
    // ==========================================
    //  URL 配置
    // ==========================================
    const URL_CENTER_RTS = "artc://a.zhezhishiyigedemo.me/live/live";
    const URL_LEFT_RTS   = "artc://c.zhezhishiyigedemo.me/live/live";
    const URL_RIGHT_RTS  = "artc://e.zhezhishiyigedemo.me/live/live";

    const URL_CENTER_FLV = "http://a.zhezhishiyigedemo.me/live/live.flv";
    const URL_LEFT_FLV   = "http://c.zhezhishiyigedemo.me/live/live.flv";
    const URL_RIGHT_FLV  = "http://e.zhezhishiyigedemo.me/live/live.flv";
    
    let playerCenter, playerLeft, playerRight;
    let currentMode = 'low-latency';
    let latencyTimer;
    let apiBaseUrl = "";
    let apiToken = "";

    document.addEventListener('DOMContentLoaded', function() {
      createPlayers();
      startLatencySimulation();
      updateModeButtons();
      
      // 自动尝试连接预填的后端
      connectBackend(true);
    });

    // ---------------------------------------
    // 1. 后端连接逻辑
    // ---------------------------------------
    async function connectBackend(isAuto = false) {
      const urlInput = document.getElementById('api-url').value.trim();
      const tokenInput = document.getElementById('api-token').value.trim();
      const statusText = document.getElementById('gello-backend-status');
      const dot = document.getElementById('backend-dot');
      const btnText = document.getElementById('connect-text');
      
      if(!urlInput) { 
        if(!isAuto) alert("请输入后端地址"); 
        return; 
      }
      
      // 去掉末尾斜杠
      apiBaseUrl = urlInput.replace(/\/$/, "");
      apiToken = tokenInput;
      
      if(!isAuto) btnText.textContent = "连接中...";
      statusText.textContent = 'Connecting...';
      
      try {
        // 调用健康检查接口
        const res = await fetch(`${apiBaseUrl}/health`);
        const data = await res.json();
        
        if (res.ok) {
          statusText.textContent = 'Connected (SSH Ready)';
          dot.className = 'dot green';
          btnText.textContent = "已连接";
          if(!isAuto) alert("成功连接到 GELLO 后端！");
        } else {
          throw new Error("状态异常");
        }
      } catch (e) {
        statusText.textContent = 'Connection Failed';
        dot.className = 'dot red';
        btnText.textContent = "连接失败";
        console.error("连接错误:", e);
        if(!isAuto) alert("连接失败，请检查：\n1. Ngrok 地址是否正确\n2. 本地 server.py 是否正在运行");
      }
    }

    // ---------------------------------------
    // 2. 启动 GELLO 遥操作 (核心功能)
    // ---------------------------------------
    async function startGelloTeleop() {
      if (!apiBaseUrl) {
        alert("请先点击上方的【连接服务器】按钮");
        return;
      }

      const btn = document.getElementById('gello-btn');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '正在发送指令...';
      
      try {
        const response = await fetch(`${apiBaseUrl}/start_gello`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiToken}` // 带上密码
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
          alert('✅ 指令已发送！\n\n正在远程 Ubuntu 机器上通过 SSH 启动 GELLO。\n请留意机器人动作。');
        } else {
          if(response.status === 401) {
              alert('❌ 认证失败：密码错误');
          } else {
              throw new Error(data.message || '未知错误');
          }
        }
      } catch (error) {
        showError('通信失败: ' + error.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    }
    
    // ---------------------------------------
    // 3. 播放器相关 (保持不变)
    // ---------------------------------------
    function createPlayers() {
      const commonConfig = {
        isLive: true, autoplay: true, useH5Prism: true,
        width: '100%', height: '100%', controlBarVisibility: 'hover',
        skinLayout: [
            {name: "bigPlayButton", align: "blabs", x: 30, y: 80},
            {name: "H5Loading", align: "cc"},
            {name: "errorDisplay", align: "tlabs", x: 0, y: 0},
            {name: "infoDisplay"},
            {name: "controlBar", align: "blabs", x: 0, y: 0, children: [
                {name: "liveDisplay", align: "tlabs", x: 15, y: 6},
                {name: "fullScreenButton", align: "tr", x: 10, y: 10},
                {name: "volume", align: "tr", x: 5, y: 10}
            ]}
        ]
      };
      
      let configCenter = { ...commonConfig, id: "J_prismPlayer_Center" };
      let configLeft   = { ...commonConfig, id: "J_prismPlayer_Left" };
      let configRight  = { ...commonConfig, id: "J_prismPlayer_Right" };
      
      if (currentMode === 'low-latency') {
        configCenter.source = URL_CENTER_RTS; 
        configCenter.rtsFallback = true; configCenter.rtsFallbackType = 'FLV'; configCenter.fallbackUrl = URL_CENTER_FLV;
        configLeft.source = URL_LEFT_RTS; 
        configLeft.rtsFallback = true; configLeft.rtsFallbackType = 'FLV'; configLeft.fallbackUrl = URL_LEFT_FLV;
        configRight.source = URL_RIGHT_RTS; 
        configRight.rtsFallback = true; configRight.rtsFallbackType = 'FLV'; configRight.fallbackUrl = URL_RIGHT_FLV;
        document.getElementById('current-protocol').textContent = 'ARTC / Low Latency';
      } else {
        configCenter.source = URL_CENTER_FLV;
        configLeft.source = URL_LEFT_FLV;
        configRight.source = URL_RIGHT_FLV;
        document.getElementById('current-protocol').textContent = 'FLV / Standard';
      }
      
      if (playerCenter) playerCenter.dispose();
      if (playerLeft) playerLeft.dispose();
      if (playerRight) playerRight.dispose();
      
      playerCenter = new Aliplayer(configCenter, () => updateStatus('Main View Ready', 'green'));
      playerLeft   = new Aliplayer(configLeft);
      playerRight  = new Aliplayer(configRight);
      
      bindPlayerEvents();
    }

    function bindPlayerEvents() {
        playerCenter.on("rtsTraceId", () => updateStatus('RTS Active (3 Streams)', 'green'));
        playerCenter.on("error", (e) => { updateStatus('Main Error', 'red'); showError('Main View: ' + e.message); });
        playerCenter.on("play", updateButtonStates);
        playerCenter.on("pause", updateButtonStates);
    }

    function updateStatus(text, color) {
        document.getElementById('status').textContent = text;
        document.getElementById('status-dot').className = 'dot ' + color;
    }

    function playAllVideos() { if(playerCenter) playerCenter.play(); if(playerLeft) playerLeft.play(); if(playerRight) playerRight.play(); }
    function pauseAllVideos() { if(playerCenter) playerCenter.pause(); if(playerLeft) playerLeft.pause(); if(playerRight) playerRight.pause(); }
    function toggleMuteAll() {
        if(!playerCenter) return;
        const m = !playerCenter.getMuted();
        playerCenter.setMuted(m); if(playerLeft) playerLeft.setMuted(m); if(playerRight) playerRight.setMuted(m);
    }
    function switchToLowLatency() { if(currentMode !== 'low-latency') { currentMode = 'low-latency'; createPlayers(); updateModeButtons(); } }
    function switchToStandard() { if(currentMode !== 'standard') { currentMode = 'standard'; createPlayers(); updateModeButtons(); } }
    function updateButtonStates() { const playing = playerCenter && playerCenter.getStatus() === 'playing'; document.getElementById('play-btn').style.opacity = playing ? 0.5 : 1; }
    function updateModeButtons() { document.getElementById('low-latency-btn').className = currentMode === 'low-latency' ? 'mode-active' : ''; document.getElementById('standard-btn').className = currentMode === 'standard' ? 'mode-active' : ''; }
    function showError(msg) { const el = document.getElementById('error-message'); el.textContent = msg; el.style.display = 'block'; setTimeout(() => el.style.display = 'none', 4000); }
    function startLatencySimulation() { clearInterval(latencyTimer); latencyTimer = setInterval(() => { const el = document.getElementById('latency-value'); const base = currentMode === 'low-latency' ? 200 : 3000; el.textContent = Math.floor(Math.random() * 150) + base; }, 1000); }
  </script>
</body>
</html>


